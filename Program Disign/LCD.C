#include <reg52.h>
#include "def.h"

unsigned char x = 0xb8;	
unsigned char y = 0x40;

unsigned char Reverse(unsigned char dat){
	unsigned char tmp = 0x80, ret = 0;
	unsigned int i;
	for(i = 0; i < 8; i ++ ) {
		ret += (dat&1) * tmp;
		tmp >>= 1;
 	    dat >>= 1;
	}
	return ret;
}

void LcdWriteCmd(unsigned char cmd){
	EN = 0;
	RS = 0;
	RW = 0;
	EN = 1;
	DATA = Reverse(cmd);
	EN = 0;
}

void LcdWriteDat(unsigned char dat){
	EN = 0;
	RS = 1;
	RW = 0;
	EN = 1;
	DATA = Reverse(dat);
	EN = 0;
}

void clear(){
	unsigned int i, j, k;
	for(k = 0; k < 8; k ++){
		for(j = 0; j < 8; j ++){
			for(i = 0; i < 8; i ++){
				LcdWriteDat(0x00);
				if(y == 0x7f){
					x ++;
					LcdWriteCmd(x);
					y = 0x40;
					LcdWriteCmd(y);
				}
				y ++;
			}
		}
	}
	x = 0xb8;
	LcdWriteCmd(x);
	y = 0x40;
	LcdWriteCmd(y);
}

void LcdInit(){
	CS1 = 0;
	CS2 = 1;
	LIGHT = 1;

	x = 0xb8;
	LcdWriteCmd(x);
	y = 0x40;
	LcdWriteCmd(y);
	clear();
}

void LcdDisplay(unsigned int k){
	unsigned int i;
	for(i = 0; i < 8; i ++) {
		LcdWriteDat(Symbol[k][i]);
		if(y == 0x7f){
			x ++;
			LcdWriteCmd(x);
			y = 0x40;
			LcdWriteCmd(y);	
		}
		else{
			y ++;
		}
	}
}

void Output(unsigned int *num){
	unsigned int i;
	if(y > 0x40){
		x ++;
	}
	LcdWriteCmd(x);
	y = 0x80 - 8 * num[0];
	LcdWriteCmd(y);
	for(i = num[0]; i > 0 ; i --){
		LcdDisplay(num[i]);
	}
}

unsigned char code Symbol[][8]={
	0x00, 0x00, 0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00, /*"0",0*/
	0x00, 0x00, 0x00, 0x42, 0x7f, 0x40, 0x00, 0x00, /*"1",1*/
	0x00, 0x00, 0x42, 0x61, 0x51, 0x49, 0x46, 0x00, /*"2",2*/
	0x00, 0x00, 0x21, 0x41, 0x45, 0x4b, 0x32, 0x00, /*"3",3*/
	0x00, 0x00, 0x18, 0x14, 0x12, 0x7f, 0x10, 0x00, /*"4",4*/
	0x00, 0x00, 0x27, 0x45, 0x45, 0x45, 0x39, 0x00, /*"5",5*/
	0x00, 0x00, 0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00, /*"6",6*/
	0x00, 0x00, 0x01, 0x01, 0x71, 0x0d, 0x03, 0x00, /*"7",7*/
	0x00, 0x00, 0x36, 0x49, 0x49, 0x49, 0x36, 0x00, /*"8",8*/
	0x00, 0x00, 0x06, 0x49, 0x49, 0x29, 0x1e, 0x00, /*"9",9*/
	0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, /*".",a*/
	0x00, 0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, /*"=",b*/
	0x00, 0x00, 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00, /*"+",c*/
	0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, /*"-",d*/
	0x00, 0x00, 0x22, 0x14, 0x08, 0x14, 0x22, 0x00, /*"*",e*/
	0x00, 0x00, 0x08, 0x08, 0x2a, 0x08, 0x08, 0x00, /*"/",f*/
};
